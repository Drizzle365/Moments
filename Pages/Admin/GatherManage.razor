@page "/Admin/Gather"
@using Moments.Model
@using Moments.Service
@inject IFreeSql Db
@inject GatherService GatherService
<div class="m-1">
    <button @onclick="StartGather" data-bs-toggle="modal" data-bs-target="#gather-res" class="btn btn-secondary">发起采集</button>
    <div class="btn-group" role="group" style="margin-left: 10px">
    </div>
</div>

<!-- Gather Modal -->
<div class="modal fade" id="gather-res" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">正在采集（@_cnt / @_friendCount）：</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: @((int)_cnt * 1.0 / (_friendCount == 0 ? 1 : _friendCount) * 100)%"></div>
                </div>
            </div>
            @if (_cnt == _friendCount)
            {
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">完成</button>
                </div>
            }
        </div>
    </div>
</div>


@code {

    long _friendCount;
    long _cnt;

    protected override async Task OnInitializedAsync()
    {
        _friendCount = await Db.Select<Friend>().CountAsync();
    }

    async Task StartGather()
    {
        _cnt = 0;
        var friends = await Db.Select<Friend>().ToListAsync();
        foreach (var item in friends)
        {
            GatherService.GatherRssItem(item);
            _cnt++;
        }
    }

}